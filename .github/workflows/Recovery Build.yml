name: Recovery ç¼–è¯‘
on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'Manifestä»“åº“åœ°å€ï¼ˆè‹¥ä½¿ç”¨SSHå¯†é’¥ï¼Œæ ¼å¼ä¸ºgit@github.com:XXXXXï¼‰ã€å·²æ•´åˆåˆ°æœ¬ä»“åº“çš„ Forkã€‘'
        required: true
        default: 'https://github.com/MengWanYu/platform_manifest_twrp_omni'
      MANIFEST_BRANCH:
        description: 'Manifeståˆ†æ”¯'
        required: true
        default: 'twrp-10.0-deprecated'
      DEVICE_TREE_URL:
        description: 'è®¾å¤‡æ ‘ä»“åº“åœ°å€'
        required: true
        default: 'https://github.com/MengWanYu/android_device_tree_vivoy70s'
      DEVICE_TREE_BRANCH:
        description: 'è®¾å¤‡æ ‘åˆ†æ”¯'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'è®¾å¤‡æ ‘åœ¨æºç ä¸­çš„è·¯å¾„'
        required: true
        default: 'device/vivo/erdv9630'
      COMMON_TREE_URL:
        description: 'é€šç”¨è®¾å¤‡æ ‘åœ°å€ï¼ˆæ— åˆ™ç•™ç©ºï¼‰'
        required: false
      COMMON_PATH:
        description: 'é€šç”¨è®¾å¤‡æ ‘åœ¨æºç ä¸­çš„è·¯å¾„ï¼ˆæ— åˆ™ç•™ç©ºï¼‰'
        required: false
      DEVICE_NAME:
        description: 'è®¾å¤‡åç§°'
        required: true
        default: 'vivo'
      MAKEFILE_NAME:
        description: 'Makefileåç§°ï¼ˆä¸å«.mkåç¼€ï¼‰'
        required: true
        default: 'omni_erdv9630'
      BUILD_TARGET:
        description: 'ç¼–è¯‘ç›®æ ‡ï¼ˆå¦‚recoveryï¼‰'
        required: true
        default: 'recovery'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: æ˜¾ç¤ºè¿è¡Œå‚æ•°
        run: |
          echo "::group::ç”¨æˆ·ç¯å¢ƒå˜é‡"
          echo "Manifeståœ°å€: ${{ github.event.inputs.MANIFEST_URL }}"
          echo "Manifeståˆ†æ”¯: ${{ github.event.inputs.MANIFEST_BRANCH }}"
          echo "è®¾å¤‡æ ‘åœ°å€: ${{ github.event.inputs.DEVICE_TREE_URL }}"
          echo "è®¾å¤‡æ ‘åˆ†æ”¯: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
          echo "è®¾å¤‡æ ‘è·¯å¾„: ${{ github.event.inputs.DEVICE_PATH }}"
          echo "è®¾å¤‡åç§°: ${{ github.event.inputs.DEVICE_NAME }}"
          echo "Makefileåç§°: ${{ github.event.inputs.MAKEFILE_NAME }}"
          echo "ç¼–è¯‘ç›®æ ‡: ${{ github.event.inputs.BUILD_TARGET }}.img"
          echo "::endgroup::"

      - name: å®‰è£…OpenJDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: é…ç½®SSHå¯†é’¥ï¼ˆå¦‚éœ€ï¼‰
        if: ${{ startsWith(github.event.inputs.MANIFEST_URL, 'git@github.com') || startsWith(github.event.inputs.DEVICE_TREE_URL, 'git@github.com') || startsWith(github.event.inputs.COMMON_TREE_URL, 'git@github.com') }}
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}

      - name: å®‰è£…repoå·¥å…·
        run: |
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo

      - name: åˆå§‹åŒ–repoï¼ˆåŒæ­¥æºç ï¼‰
        run: |
          mkdir workspace
          cd workspace
          echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT
          git config --global user.name "Nico170420"
          git config --global user.email "b170420nc@gmail.com"
          repo init --depth=1 -u ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }}
        id: pwd

      - name: åŒæ­¥æºç ï¼ˆrepo syncï¼‰
        run: |
          repo sync -j$(nproc --all) --force-sync
        working-directory: workspace

      - name: å…‹éš†è®¾å¤‡æ ‘
        run: |
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.DEVICE_PATH }}
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      - name: å…‹éš†é€šç”¨è®¾å¤‡æ ‘ï¼ˆå¦‚éœ€ï¼‰
        if: |
          github.event.inputs.COMMON_TREE_URL != '' && github.event.inputs.COMMON_PATH != ''
        run: |
          git clone ${{ github.event.inputs.COMMON_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.COMMON_PATH }}
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      - name: æ£€æŸ¥æ„å»ºæ ‘ç±»å‹
        uses: haya14busa/action-cond@v1
        id: buildtree
        with:
          cond: ${{ github.event.inputs.MANIFEST_BRANCH == 'twrp-11' || github.event.inputs.MANIFEST_BRANCH == 'twrp-12.1' }}
          if_true: twrp
          if_false: omni

      - name: åŒæ­¥è®¾å¤‡ä¾èµ–
        run: |
          DEPS_FILE="${{ github.event.inputs.DEVICE_PATH }}/${{ steps.buildtree.outputs.value }}.dependencies"
          SCRIPT_PATH="${GITHUB_WORKSPACE}/scripts/convert.sh"
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "è„šæœ¬è·¯å¾„: $SCRIPT_PATH"
          echo "ä¾èµ–æ–‡ä»¶: $DEPS_FILE"
          echo "æ„å»ºæ ‘ç±»å‹: ${{ steps.buildtree.outputs.value }}"
          echo "ä¾èµ–æ–‡ä»¶æ˜¯å¦å­˜åœ¨: [ -f ${DEPS_FILE} ] && echo 'å­˜åœ¨' || echo 'ä¸å­˜åœ¨'"
          echo "================"
          if [ -f "$DEPS_FILE" ]; then
            bash "$SCRIPT_PATH" "$DEPS_FILE"
          else
            echo "âš ï¸  ä¾èµ–æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡è½¬æ¢: $DEPS_FILE"
          fi
          repo sync -j$(nproc --all)
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}
        continue-on-error: true

      - name: å‡†å¤‡å­—ä½“æ–‡ä»¶ï¼ˆä¿®å¤ TWRP å­—ä½“ç¼ºå¤±é—®é¢˜ï¼‰
        run: |
          # åˆ›å»ºå¤šä¸ªç¼–è¯‘ç³»ç»Ÿå¯èƒ½æŸ¥æ‰¾çš„å­—ä½“ç›®å½•
          FONT_DIRS=(
            "${{ steps.pwd.outputs.workspace-folder }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/obj/PACKAGING/recovery_font_files_intermediates"
            "${{ steps.pwd.outputs.workspace-folder }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/obj/ETC/recovery_font_files_intermediates"
            "${{ steps.pwd.outputs.workspace-folder }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/system/fonts"
            "${{ steps.pwd.outputs.workspace-folder }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery/root/fonts"
          )
          
          for font_dir in "${FONT_DIRS[@]}"; do
            mkdir -p "$font_dir"
            echo "âœ… åˆ›å»ºç›®å½•: $font_dir"
          done
          
          # ä»è®¾å¤‡æ ‘å¤åˆ¶å­—ä½“æ–‡ä»¶
          DEVICE_FONT_DIR="${{ steps.pwd.outputs.workspace-folder }}/${{ github.event.inputs.DEVICE_PATH }}/recovery/root/fonts"
          if [ -f "$DEVICE_FONT_DIR/Roboto-Regular.ttf" ]; then
            file_type=$(file -b "$DEVICE_FONT_DIR/Roboto-Regular.ttf")
            echo "âœ… æ‰¾åˆ°è®¾å¤‡æ ‘å­—ä½“: $file_type"
            
            # å¤åˆ¶åˆ°æ‰€æœ‰å¯èƒ½çš„å­—ä½“ç›®å½•
            for font_dir in "${FONT_DIRS[@]}"; do
              cp "$DEVICE_FONT_DIR/Roboto-Regular.ttf" "$font_dir/"
              echo "âœ… å¤åˆ¶åˆ°: $font_dir"
            done
            
            # åˆ›å»ºé¢å¤–çš„ç¬¦å·é“¾æ¥å’Œå‰¯æœ¬
            PRIMARY_FONT_DIR="${{ steps.pwd.outputs.workspace-folder }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/obj/PACKAGING/recovery_font_files_intermediates"
            cd "$PRIMARY_FONT_DIR"
            
            # åˆ›å»ºå¤šä¸ªå¯èƒ½çš„å­—ä½“æ–‡ä»¶å
            cp Roboto-Regular.ttf Roboto-Regular-en.ttf
            cp Roboto-Regular.ttf roboto-regular.ttf
            cp Roboto-Regular.ttf Roboto_Regular.ttf
            cp Roboto-Regular.ttf roboto_regular.ttf
            
            # åˆ›å»ºè¯­è¨€ç‰¹å®šçš„å­—ä½“æ–‡ä»¶
            cp Roboto-Regular.ttf Roboto-Regular_zh_CN.ttf
            cp Roboto-Regular.ttf Roboto-Regular_zh_TW.ttf
            
            echo "âœ… å­—ä½“æ–‡ä»¶å‡†å¤‡å®Œæˆ"
            echo "ğŸ“‹ ä¸»è¦å­—ä½“ç›®å½•å†…å®¹:"
            ls -lh "$PRIMARY_FONT_DIR"
          else
            echo "âŒ é”™è¯¯: è®¾å¤‡æ ‘ä¸­æ²¡æœ‰æ‰¾åˆ°Roboto-Regular.ttf"
            exit 1
          fi
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      - name: ç¦ç”¨æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆï¼ˆç»•è¿‡å­—ä½“ä¾èµ–ï¼‰
        run: |
          # ä¿®æ”¹TWRPç¼–è¯‘é…ç½®ï¼Œç¦ç”¨æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆ
          RECOVERY_MAKEFILE="${{ steps.pwd.outputs.workspace-folder }}/bootable/recovery/gui/Android.mk"
          
          if [ -f "$RECOVERY_MAKEFILE" ]; then
            echo "âœ… æ‰¾åˆ° recovery/gui/Android.mk"
            
            # æŸ¥æ‰¾å¹¶æ³¨é‡Šæ‰æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆçš„è§„åˆ™
            if grep -q "recovery_text_res" "$RECOVERY_MAKEFILE"; then
              echo "âœ… æ‰¾åˆ°æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆè§„åˆ™ï¼Œç¦ç”¨ä¸­..."
              
              # åˆ›å»ºå¤‡ä»½
              cp "$RECOVERY_MAKEFILE" "$RECOVERY_MAKEFILE.backup"
              
              # æ³¨é‡Šæ‰æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆçš„è§„åˆ™
              sed -i '/recovery_text_res_intermediates/s/^/# DISABLED: /' "$RECOVERY_MAKEFILE"
              sed -i '/RecoveryImageGenerator.jar/s/^/# DISABLED: /' "$RECOVERY_MAKEFILE"
              sed -i '/wipe_data/s/^/# DISABLED: /' "$RECOVERY_MAKEFILE"
              
              echo "âœ… å·²ç¦ç”¨æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆè§„åˆ™"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆè§„åˆ™"
            fi
          else
            echo "âš ï¸  æœªæ‰¾åˆ° $RECOVERY_MAKEFILE"
          fi
          
          # å°è¯•é€šè¿‡ç¯å¢ƒå˜é‡ç¦ç”¨
          echo "export RECOVERY_SKIP_TEXT_IMAGE_GENERATION=true" >> ~/.bashrc
          echo "export TW_SKIP_TEXT_IMAGE_GENERATION=true" >> ~/.bashrc
          
          echo "âœ… ç¦ç”¨æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆé…ç½®å®Œæˆ"
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      - name: é…ç½® BoardConfig.mk å­—ä½“è·¯å¾„ï¼ˆæ ¹æ²»æ–¹æ¡ˆï¼‰
        run: |
          # è®¾å¤‡æ ‘è·¯å¾„
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
          
          # æŸ¥æ‰¾ BoardConfig.mk æ–‡ä»¶
          BOARDCONFIG_FILE="${{ steps.pwd.outputs.workspace-folder }}/${DEVICE_PATH}/BoardConfig.mk"
          
          if [ -f "$BOARDCONFIG_FILE" ]; then
            echo "âœ… æ‰¾åˆ° BoardConfig.mk: $BOARDCONFIG_FILE"
            
            # ç¡®ä¿æœ‰ç¦ç”¨æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆçš„é…ç½®
            if ! grep -q "RECOVERY_SKIP_TEXT_IMAGE_GENERATION" "$BOARDCONFIG_FILE"; then
              echo "âœ… æ·»åŠ  RECOVERY_SKIP_TEXT_IMAGE_GENERATION é…ç½®"
              echo "" >> "$BOARDCONFIG_FILE"
              echo "# ç¦ç”¨recoveryç•Œé¢æ–‡æœ¬å›¾ç‰‡ç”Ÿæˆï¼Œé¿å…å­—ä½“ä¾èµ–" >> "$BOARDCONFIG_FILE"
              echo "RECOVERY_SKIP_TEXT_IMAGE_GENERATION := true" >> "$BOARDCONFIG_FILE"
            else
              echo "âœ… å·²å­˜åœ¨ RECOVERY_SKIP_TEXT_IMAGE_GENERATION é…ç½®"
            fi
          else
            echo "âš ï¸  æœªæ‰¾åˆ° BoardConfig.mk æ–‡ä»¶"
          fi
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      # ä¿®å¤æ ¸å¿ƒï¼šå°†ç¯å¢ƒå‡†å¤‡æ­¥éª¤ç§»åˆ°ã€Œæºç åŒæ­¥+è®¾å¤‡æ ‘å…‹éš†ä¹‹åã€ï¼Œé¿å…è·¯å¾„ä¸å­˜åœ¨æŠ¥é”™
      - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒï¼ˆå®‰è£…ä¾èµ–+é…ç½®zopflipngï¼‰
        run: |
          # 1. æ¸…ç†ä¹‹å‰å¯èƒ½æ®‹ç•™çš„zopflipngæ–‡ä»¶ï¼Œé¿å…å†²çª
          sudo rm -rf zopfli /usr/bin/zopflipng

          # 2. å®‰è£…åŸºç¡€ç¼–è¯‘ä¾èµ–ï¼ˆgitã€cmakeã€ç¼–è¯‘å™¨ç­‰ï¼‰
          sudo apt update && sudo apt install -y git build-essential cmake libpng-dev

          # 3. ç¼–è¯‘å®‰è£…zopflipngï¼ˆå›¾ç‰‡å‹ç¼©å·¥å…·ï¼ŒTWRPç¼–è¯‘å¿…éœ€ï¼‰
          git clone https://github.com/google/zopfli.git --depth 1  # æµ…å…‹éš†åŠ é€Ÿ
          cd zopfli/build 2>/dev/null || mkdir -p zopfli/build && cd zopfli/build  # ç¡®ä¿è¿›å…¥buildç›®å½•
          cmake .. -DCMAKE_BUILD_TYPE=Release  # é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆReleaseæ¨¡å¼ä¼˜åŒ–æ€§èƒ½ï¼‰
          make -j$(nproc --all)  # å¤šçº¿ç¨‹ç¼–è¯‘

          # 4. å¤åˆ¶å·¥å…·åˆ°ç³»ç»Ÿç›®å½•ï¼Œå¹¶éªŒè¯å¯ç”¨æ€§
          if [ -f "./zopflipng" ]; then
            sudo cp ./zopflipng /usr/bin/
            echo "âœ… zopflipngå·¥å…·å¤åˆ¶æˆåŠŸï¼"
            # éªŒè¯å·¥å…·æ˜¯å¦å¯æ‰§è¡Œï¼ˆéƒ¨åˆ†ç‰ˆæœ¬æ— --versionï¼Œç”¨--helpåˆ¤æ–­ï¼‰
            if zopflipng --help >/dev/null 2>&1; then
              echo "âœ… zopflipngå·¥å…·å¯æ­£å¸¸è¿è¡Œï¼"
            else
              echo "âœ… zopflipngå·¥å…·å®‰è£…æˆåŠŸï¼ˆæ— --versionå‚æ•°ï¼Œä¸å½±å“ç¼–è¯‘ä½¿ç”¨ï¼‰"
            fi
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼šæœªæ‰¾åˆ°zopflipngå¯æ‰§è¡Œæ–‡ä»¶"
            ls -l ./  # åˆ—å‡ºç›®å½•å†…å®¹ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
            exit 1
          fi
          cd ../../  # å›åˆ°å·¥ä½œç›®å½•

          # 5. å®‰è£…å…¶ä»–ç¼–è¯‘ä¾èµ–ï¼ˆå®‰å“æ„å»ºã€å†…æ ¸ç¼–è¯‘ç›¸å…³ï¼‰
          DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
            linux-modules-extra-$(uname -r) \
            gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib \
            libc6-dev lib32ncurses-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils \
            xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses-dev libsdl1.2-dev \
            build-essential libgtk-3-dev libglu1-mesa-dev freeglut3-dev git libxml2 lzop pngcrush schedtool squashfs-tools \
            imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev libncurses6 python3 tar
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      - name: è®¾ç½®äº¤æ¢ç©ºé—´ï¼ˆé¿å…ç¼–è¯‘å†…å­˜ä¸è¶³ï¼‰
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 12

      - name: ç¼–è¯‘Recovery
        run: |
          source build/envsetup.sh  # åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
          export ALLOW_MISSING_DEPENDENCIES=true  # å…è®¸ç¼ºå¤±éå…³é”®ä¾èµ–ï¼ˆé€‚é…è‡ªå®šä¹‰è®¾å¤‡æ ‘ï¼‰
          lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng  # é€‰æ‹©ç¼–è¯‘ç›®æ ‡
          make clean  # æ¸…ç†æ—§ç¼–è¯‘äº§ç‰©
          
          # å…³é”®ï¼šç»™æ„å»ºç³»ç»Ÿåˆ›å»ºzopflipngè½¯é“¾æ¥ï¼ˆninjaä»…è¯†åˆ«outç›®å½•ä¸‹çš„å·¥å…·ï¼‰
          LINK_PATH="${{ steps.pwd.outputs.workspace-folder }}/out/host/linux-x86/bin/zopflipng"
          LINK_DIR="$(dirname $LINK_PATH)"
          
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -d "$LINK_DIR" ]; then
            mkdir -p "$LINK_DIR"
            echo "âœ… å·²åˆ›å»ºç›®å½•ï¼š$LINK_DIR"
          fi
          
          # åˆ›å»ºè½¯é“¾æ¥
          sudo ln -sf /usr/bin/zopflipng $LINK_PATH
          echo "âœ… å·²åˆ›å»ºzopflipngè½¯é“¾æ¥ï¼š$LINK_PATH"
          
          make ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc --all)  # å¼€å§‹ç¼–è¯‘
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©åˆ°Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
            workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
            workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*vendor*.img
          name: ${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
          tag_name: ${{ github.run_id }}
          body: |
            ğŸ”§ ç¼–è¯‘ä¿¡æ¯ï¼š
            - Manifeståˆ†æ”¯: ${{ github.event.inputs.MANIFEST_BRANCH }}
            - è®¾å¤‡åç§°: ${{ github.event.inputs.DEVICE_NAME }}
            - ç¼–è¯‘ç›®æ ‡: ${{ github.event.inputs.BUILD_TARGET }}.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

